<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Download Performance Test Results</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f7fa;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 {
            margin: 0;
            font-size: 2.5rem;
        }
        .header .subtitle {
            margin: 10px 0 0 0;
            opacity: 0.9;
            font-size: 1.1rem;
        }
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            padding: 30px;
            background: #f8fafc;
        }
        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #667eea;
        }
        .card h3 {
            margin: 0 0 10px 0;
            color: #667eea;
            font-size: 1.1rem;
        }
        .metric {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
        }
        .metric .label {
            color: #666;
        }
        .metric .value {
            font-weight: bold;
            color: #333;
        }
        .charts-section {
            padding: 30px;
        }
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }
        .chart-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            height: 400px;
            position: relative;
        }
        .chart-container h3 {
            margin: 0 0 20px 0;
            color: #333;
            text-align: center;
            height: 40px;
        }
        .chart-wrapper {
            position: relative;
            height: 320px;
            width: 100%;
        }
        .tables-section {
            padding: 30px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }
        tr:hover {
            background-color: #f5f7fa;
        }
        .success-high { color: #10b981; font-weight: bold; }
        .success-medium { color: #f59e0b; font-weight: bold; }
        .success-low { color: #ef4444; font-weight: bold; }
        .timing-section {
            background: #f8fafc;
            padding: 30px;
            margin: 20px 0;
        }
        .timing-breakdown {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 10px 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .winner-badge {
            background: #10b981;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        .file-details {
            max-height: 400px;
            overflow-y: auto;
        }
        .mb { color: #666; font-size: 0.9rem; }
        .config-note {
            background-color: #e8f5e8;
            border-left: 4px solid #4caf50;
            padding: 15px;
            margin: 20px;
            border-radius: 4px;
        }
        .performance-note {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 20px;
            border-radius: 4px;
        }
        .profiling-section {
            padding: 30px;
            background: #f8fafc;
        }
        .profiling-method-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #667eea;
        }
        .profiling-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin: 20px 0;
        }
        .profiling-summary, .profiling-breakdown {
            background: #f8fafc;
            padding: 20px;
            border-radius: 8px;
        }
        .metric-row {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding: 8px 0;
            border-bottom: 1px solid #e2e8f0;
        }
        .metric-row .label {
            color: #64748b;
            font-weight: 500;
        }
        .metric-row .value {
            color: #1e293b;
            font-weight: 600;
        }
        .profiling-output {
            background: #f8fafc;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.85rem;
            line-height: 1.4;
            overflow-x: auto;
            white-space: pre-wrap;
            color: #334155;
            border: 1px solid #e2e8f0;
        }
        .comparison-analysis {
            padding: 30px;
            background: #f8fafc;
        }
        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .comparison-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .comparison-card.winner {
            border-left: 4px solid #10b981;
        }
        .comparison-card.loser {
            border-left: 4px solid #ef4444;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Enhanced Download Performance Test Results</h1>
            <div class="subtitle">
                Comprehensive performance comparison with detailed metrics and profiling analysis
            </div>
            <div class="subtitle">
                Generated on {{ timestamp }}
            </div>
        </div>

        <div class="summary-cards">
            {% for tool_name, agg_data in tool_aggregates.items() %}
            <div class="card">
                <h3>{{ tool_name }}</h3>
                <div class="metric">
                    <span class="label">Avg Throughput</span>
                    <span class="value">{{ "%.2f"|format(agg_data.get("avg_throughput", 0) or 0) }} MB/s</span>
                </div>
                <div class="metric">
                    <span class="label">Success Rate</span>
                    <span class="value">{{ "%.1f"|format(agg_data.get("success_rate", 0) or 0) }}%</span>
                </div>
                <div class="metric">
                    <span class="label">Peak Memory</span>
                    <span class="value">{{ "%.0f"|format(agg_data.get("avg_peak_memory_mb", 0) or 0) }} MB</span>
                </div>
                <div class="metric">
                    <span class="label">Avg CPU</span>
                    <span class="value">{{ "%.1f"|format(agg_data.get("avg_cpu_percent", 0) or 0) }}%</span>
                </div>
                <div class="metric">
                    <span class="label">Total Download Time</span>
                    <span class="value">{{ "%.1f"|format(agg_data.get("avg_download_time", 0) or 0) }}s</span>
                </div>
            </div>
            {% endfor %}
        </div>

        <div class="charts-section">
            <h2>üìà Performance Comparison Charts</h2>
            <div class="charts-grid">
                <div class="chart-container">
                    <h3>Throughput Comparison (MB/s)</h3>
                    <div class="chart-wrapper">
                        <canvas id="throughputChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <h3>Download Time Comparison</h3>
                    <div class="chart-wrapper">
                        <canvas id="timeChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <h3>Memory Usage Comparison</h3>
                    <div class="chart-wrapper">
                        <canvas id="memoryChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <h3>CPU Usage Comparison</h3>
                    <div class="chart-wrapper">
                        <canvas id="cpuChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="timing-section">
            <h2>‚è±Ô∏è Detailed Performance Data</h2>
        </div>

        <div class="profiling-section">
            <h2>üîç Detailed Performance Profiling & Optimization Insights</h2>
            {% for metric in all_metrics %}
                {% if metric.profiling_analysis %}
                <div class="profiling-method-card">
                    <h3>üìä {{ metric.tool_name }} - Run {{ metric.run_number }} Profiling Analysis</h3>
                    <div class="profiling-grid">
                        <div class="profiling-summary">
                            <h4>üìã Performance Summary</h4>
                            <div class="metric-row">
                                <span class="label">Total Runtime:</span>
                                <span class="value">{{ "%.3f"|format(metric.total_time) }}s</span>
                            </div>
                            <div class="metric-row">
                                <span class="label">Throughput:</span>
                                <span class="value">{{ "%.2f"|format(metric.throughput_mb_s) }} MB/s</span>
                            </div>
                            <div class="metric-row">
                                <span class="label">Peak Memory:</span>
                                <span class="value">{{ "%.1f"|format(metric.peak_memory_mb) }} MB</span>
                            </div>
                            <div class="metric-row">
                                <span class="label">Peak CPU:</span>
                                <span class="value">{{ "%.1f"|format(metric.peak_cpu_percent) }}%</span>
                            </div>
                            <div class="metric-row">
                                <span class="label">Files Downloaded:</span>
                                <span class="value">{{ metric.files_successful }}/{{ metric.files_attempted }}</span>
                            </div>
                        </div>
                        <div class="profiling-breakdown">
                            <h4>üéØ Key Performance Bottlenecks</h4>
                            <p>The following analysis shows the most time-consuming operations and potential optimization opportunities:</p>
                        </div>
                    </div>
                    <div class="profiling-details">
                        <h4>üîç Detailed Profiling Output</h4>
                        <pre class="profiling-output">{{ metric.profiling_analysis }}</pre>
                    </div>
                </div>
                {% endif %}
            {% endfor %}
        </div>

        <div class="comparison-analysis">
            <h2>üèÅ Performance Comparison & Optimization Analysis</h2>
            {% if tested_methods|length > 1 %}
                {% set winner_method = tested_methods[0] %}
                {% set winner_throughput = tool_aggregates[winner_method].get("avg_throughput", 0) or 0 %}
                {% for method in tested_methods %}
                    {% if (tool_aggregates[method].get("avg_throughput", 0) or 0) > winner_throughput %}
                        {% set winner_method = method %}
                        {% set winner_throughput = tool_aggregates[method].get("avg_throughput", 0) or 0 %}
                    {% endif %}
                {% endfor %}
                <div class="comparison-grid">
                    <div class="comparison-card winner">
                        <h3>üèÜ Winner: {{ winner_method }}</h3>
                        <p><strong>Best overall throughput:</strong> {{ "%.2f"|format(winner_throughput) }} MB/s</p>
                    </div>
                    {% for method in tested_methods %}
                        {% if method != winner_method %}
                        <div class="comparison-card loser">
                            <h3>{{ method }}</h3>
                            <p><strong>Throughput:</strong> {{ "%.2f"|format(tool_aggregates[method].get("avg_throughput", 0) or 0) }} MB/s</p>
                            {% set method_throughput = tool_aggregates[method].get("avg_throughput", 0) or 0 %}
                            {% set performance_diff = ((winner_throughput - method_throughput) / winner_throughput * 100) if winner_throughput > 0 else 0 %}
                            <p><strong>Performance Gap:</strong> {{ "%.1f"|format(performance_diff) }}% slower</p>
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
            {% endif %}
        </div>

        <div class="tables-section">
            <h2>üìã Detailed Results Tables</h2>

            <h3>üìä Aggregated Performance Summary</h3>
            <table>
                <thead>
                    <tr>
                        <th>Tool</th>
                        <th>Avg Throughput (MB/s)</th>
                        <th>Min-Max Throughput</th>
                        <th>Success Rate</th>
                        <th>Avg Memory (MB)</th>
                        <th>Avg CPU (%)</th>
                        <th>Avg Download Time</th>
                        <th>Files Downloaded</th>
                    </tr>
                </thead>
                <tbody>
                    {% for tool_name, agg_data in tool_aggregates.items() %}
                    <tr>
                        <td><strong>{{ tool_name }}</strong></td>
                        <td>{{ "%.2f"|format(agg_data.get("avg_throughput", 0) or 0) }}</td>
                        <td>{{ "%.2f"|format(agg_data.get("min_throughput", 0) or 0) }} - {{ "%.2f"|format(agg_data.get("max_throughput", 0) or 0) }}</td>
                        <td>{{ "%.1f"|format(agg_data.get("success_rate", 0) or 0) }}%</td>
                        <td>{{ "%.0f"|format(agg_data.get("avg_peak_memory_mb", 0) or 0) }}</td>
                        <td>{{ "%.1f"|format(agg_data.get("avg_cpu_percent", 0) or 0) }}</td>
                        <td>{{ "%.1f"|format(agg_data.get("avg_download_time", 0) or 0) }}s</td>
                        <td>{{ agg_data.get("total_files_successful", 0) }}/{{ agg_data.get("total_files_attempted", 0) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <h3>üîç Individual Test Run Details</h3>
            <table>
                <thead>
                    <tr>
                        <th>Tool</th>
                        <th>Run #</th>
                        <th>Total Time (s)</th>
                        <th>Throughput (MB/s)</th>
                        <th>Files</th>
                        <th>Memory (MB)</th>
                        <th>CPU (%)</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for metric in all_metrics %}
                    {% set success_rate = (metric.files_successful / metric.files_attempted * 100) if metric.files_attempted > 0 else 0 %}
                    {% if success_rate >= 90 %}
                        {% set success_class = "success-high" %}
                        {% set status = "‚úÖ Success" %}
                    {% elif success_rate >= 50 %}
                        {% set success_class = "success-medium" %}
                        {% set status = "‚ö†Ô∏è Partial" %}
                    {% else %}
                        {% set success_class = "success-low" %}
                        {% set status = "‚ùå Failed" %}
                    {% endif %}
                    <tr>
                        <td><strong>{{ metric.tool_name }}</strong></td>
                        <td>{{ metric.run_number }}</td>
                        <td>{{ "%.2f"|format(metric.total_time) }}</td>
                        <td>{{ "%.2f"|format(metric.throughput_mb_s) }}</td>
                        <td>{{ metric.files_successful }}/{{ metric.files_attempted }}</td>
                        <td>{{ "%.1f"|format(metric.peak_memory_mb) }}</td>
                        <td>{{ "%.1f"|format(metric.peak_cpu_percent) }}</td>
                        <td class="{{ success_class }}">{{ status }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <h3>üìÅ Manifest File Details</h3>
            <div class="file-details">
                <table>
                    <thead>
                        <tr>
                            <th>GUID</th>
                            <th>Filename</th>
                            <th>File Size (bytes)</th>
                            <th>Size (MB)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in manifest_data %}
                        {% set file_size = item.get("file_size", 0) %}
                        {% set size_mb = (file_size / (1024 * 1024)) %}
                        <tr>
                            <td><code>{{ item.get("object_id", "N/A").split("/")[-1] if "/" in item.get("object_id", "") else item.get("object_id", "N/A") }}</code></td>
                            <td>{{ item.get("file_name", "N/A") }}</td>
                            <td>{{ "{:,}".format(file_size) }}</td>
                            <td class="mb">{{ "%.2f"|format(size_mb) }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Prepare data for charts
        {%- if tested_methods %}
        {%- set chart_methods = tested_methods %}
        {%- set throughput_values = [] %}
        {%- set time_values = [] %}
        {%- set memory_values = [] %}
        {%- set cpu_values = [] %}
        {%- for method in tested_methods %}
        {%- set _ = throughput_values.append(tool_aggregates[method].get("avg_throughput", 0) or 0) %}
        {%- set _ = time_values.append(tool_aggregates[method].get("avg_download_time", 0) or 0) %}
        {%- set _ = memory_values.append(tool_aggregates[method].get("avg_peak_memory_mb", 0) or 0) %}
        {%- set _ = cpu_values.append(tool_aggregates[method].get("avg_cpu_percent", 0) or 0) %}
        {%- endfor %}
        {%- else %}
        {%- set chart_methods = ["No Data"] %}
        {%- set throughput_values = [0] %}
        {%- set time_values = [0] %}
        {%- set memory_values = [0] %}
        {%- set cpu_values = [0] %}
        {%- endif %}

        const methods = {{ chart_methods|tojson }};
        const throughputData = {{ throughput_values|tojson }};
        const timeData = {{ time_values|tojson }};
        const memoryData = {{ memory_values|tojson }};
        const cpuData = {{ cpu_values|tojson }};

        // Chart configurations
        const chartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0,0,0,0.1)'
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        };

        // Throughput Chart
        new Chart(document.getElementById('throughputChart'), {
            type: 'bar',
            data: {
                labels: methods,
                datasets: [{
                    data: throughputData,
                    backgroundColor: ['#667eea', '#764ba2', '#f093fb', '#f5576c'],
                    borderColor: ['#5a67d8', '#6b46c1', '#ec4899', '#ef4444'],
                    borderWidth: 2
                }]
            },
            options: {
                ...chartOptions,
                scales: {
                    ...chartOptions.scales,
                    y: {
                        ...chartOptions.scales.y,
                        title: {
                            display: true,
                            text: 'Throughput (MB/s)'
                        }
                    }
                }
            }
        });

        // Time Chart
        new Chart(document.getElementById('timeChart'), {
            type: 'bar',
            data: {
                labels: methods,
                datasets: [{
                    data: timeData,
                    backgroundColor: ['#10b981', '#059669', '#34d399', '#6ee7b7'],
                    borderColor: ['#047857', '#065f46', '#059669', '#047857'],
                    borderWidth: 2
                }]
            },
            options: {
                ...chartOptions,
                scales: {
                    ...chartOptions.scales,
                    y: {
                        ...chartOptions.scales.y,
                        title: {
                            display: true,
                            text: 'Download Time (seconds)'
                        }
                    }
                }
            }
        });

        // Memory Chart
        new Chart(document.getElementById('memoryChart'), {
            type: 'bar',
            data: {
                labels: methods,
                datasets: [{
                    data: memoryData,
                    backgroundColor: ['#f59e0b', '#d97706', '#fbbf24', '#fcd34d'],
                    borderColor: ['#d97706', '#b45309', '#f59e0b', '#d97706'],
                    borderWidth: 2
                }]
            },
            options: {
                ...chartOptions,
                scales: {
                    ...chartOptions.scales,
                    y: {
                        ...chartOptions.scales.y,
                        title: {
                            display: true,
                            text: 'Memory Usage (MB)'
                        }
                    }
                }
            }
        });

        // CPU Chart
        new Chart(document.getElementById('cpuChart'), {
            type: 'bar',
            data: {
                labels: methods,
                datasets: [{
                    data: cpuData,
                    backgroundColor: ['#ef4444', '#dc2626', '#f87171', '#fca5a5'],
                    borderColor: ['#dc2626', '#b91c1c', '#ef4444', '#dc2626'],
                    borderWidth: 2
                }]
            },
            options: {
                ...chartOptions,
                scales: {
                    ...chartOptions.scales,
                    y: {
                        ...chartOptions.scales.y,
                        title: {
                            display: true,
                            text: 'CPU Usage (%)'
                        }
                    }
                }
            }
        });

        // Responsive chart resizing
        window.addEventListener('resize', function() {
            Chart.helpers.each(Chart.instances, function(instance) {
                instance.resize();
            });
        });
    </script>
</body>
</html>
